# DMAT Chronology AI - ZOOM接続までの業務フロー

## 概要

本システムは、DMAT（災害派遣医療チーム）の活動において、Zoom会議の音声をリアルタイムで文字起こしし、AIによってクロノロジー（時系列記録）として自動分類・要約するシステムです。

---

## 1. 事前準備（システム管理者）

### 1.1 環境構築

```bash
# バックエンド起動
cd backend
uvicorn app.main:app --port 8000

# フロントエンド起動
cd frontend
npm run dev
```

### 1.2 API設定（設定画面）

1. **Zoom API設定**
   - 設定画面 > Zoom API設定
   - Client ID、Client Secret、Account ID を入力
   - 「保存」をクリック

2. **Azure OpenAI設定**（環境変数）
   - `AZURE_OPENAI_ENDPOINT`
   - `AZURE_OPENAI_KEY`
   - `AZURE_OPENAI_DEPLOYMENT`

3. **Azure Speech設定**（環境変数）
   - `AZURE_SPEECH_KEY`
   - `AZURE_SPEECH_REGION`

---

## 2. 災害発生時の初期設定

### 2.1 災害ボックスの作成

1. トップページ > 「新規災害ボックス」
2. 入力項目：
   - **災害名**: 例）能登半島地震
   - **発災日**: 発災日を選択
3. 「作成」をクリック

→ 4つのセッション（活動指揮、搬送調整、情報分析、物資支援）が自動作成されます

### 2.2 本部マスタの設定

1. 災害ボックス > 本部マスタ管理
2. 参加する本部を追加：
   - **本部名**: 表示名（例：北海道調整本部）
   - **Zoomパターン**: Zoom表示名のマッチングパターン
   - **参加セッション**: 該当するセッションにチェック

### 2.3 ユーザー辞書の設定（推奨）

設定画面 > ユーザー辞書

よく誤認識される用語を登録：
| 誤認識 | 正しいテキスト |
|--------|----------------|
| ディーマット | DMAT |
| てぃーまっと | DMAT |
| 患者搬送班 | 患者搬送本部 |

---

## 3. セッション開始（会議開始時）

### 3.1 Zoom会議の準備

1. Zoomで会議を開始
2. 会議IDをコピー

### 3.2 セッションへの接続

1. 災害ボックス > 該当セッションを選択
2. 「Zoom会議に接続」をクリック
3. Zoom会議IDを入力
4. 「接続」をクリック

→ Botが会議に参加し、音声取得を開始

### 3.3 参加者の確認

1. セッション > 参加者一覧
2. Zoom参加者が自動追加される
3. 本部との紐付けを確認：
   - 自動マッチング済み → 緑のチェック
   - 未確定 → 黄色の警告アイコン → 手動で本部を選択

---

## 4. 音声入力（会議中）

### 4.1 自動音声取得（Zoom経由）

- Zoom Botが会議音声をリアルタイム取得
- 発言を検出 → STT → AI分類 → クロノロジー追加

### 4.2 手動音声入力

1. セッション > 音声入力
2. 「録音開始」をクリック
3. 発言終了後、自動または手動で送信
4. デバッグ情報で処理状況を確認：
   - `stage: stt` → 音声認識中
   - `stage: classify` → AI分類中
   - `stage: done` → 完了

---

## 5. クロノロジー確認・編集

### 5.1 リアルタイム表示

セッション > クロノロジー

表示内容：
- **日時**: 発言時刻
- **発信者**: 本部名（未確定の場合は警告表示）
- **表題**: AI生成の1行要約
- **本文**: AI生成の詳細要約
- **分類**: 指示/依頼/報告/決定/確認/リスク/その他
- **タスク**: タスクフラグ

### 5.2 編集機能

1. エントリの「編集」アイコンをクリック
2. 編集可能項目：
   - 表題（summary）
   - AI要約（ai_note）
   - 文字起こし（text_raw）
   - 分類カテゴリ
   - タスクフラグ
   - 発信者（本部）
3. 「保存」をクリック

### 5.3 フィルタリング

- カテゴリで絞り込み
- 本部で絞り込み
- 未確定のみ表示

---

## 6. セッション終了

### 6.1 Zoom接続解除

1. セッション > 「Zoom接続解除」
2. Botが会議から退出

### 6.2 セッション終了

1. セッション > 「セッション終了」
2. ステータスが「終了」に変更

---

## 7. トラブルシューティング

### 音声認識が動作しない

1. 設定画面でSTT設定を確認
2. Azure Speech設定が正しいか確認
3. 音声入力画面のデバッグ情報を確認

### AI分類が動作しない

1. 設定画面でOpenAI設定を確認
2. Azure OpenAI設定が正しいか確認

### 発信者が「未確定」になる

1. 本部マスタに該当パターンを追加
2. ユーザー辞書で誤認識を修正
3. 手動でクロノロジーエントリを編集

### Zoom接続エラー

1. Zoom API設定を確認
2. Client ID/Secret/Account IDが正しいか確認
3. Zoom側の権限設定を確認

---

## 8. カスタマイズ

### LLMプロンプトの調整

設定画面 > LLMプロンプト設定

- システムプロンプトをカスタマイズ可能
- Temperature、Max Tokensの調整
- 「デフォルトに戻す」で初期状態に復元

### ユーザー辞書の活用

- 災害固有の地名、病院名、略語を登録
- 誤認識パターンを継続的に追加

---

## 9. データ構造

```
災害ボックス（Incident）
├── 活動指揮セッション
│   ├── 参加者
│   ├── クロノロジー
│   └── 本部マスタ（共有）
├── 搬送調整セッション
├── 情報分析セッション
├── 物資支援セッション
└── 追加セッション（任意）
```

---

## 10. 連絡先

- 技術的な問題: システム管理者
- 運用に関する問い合わせ: DMAT事務局
