# 要件定義書：Push-to-Talk方式クロノロジーシステム

**作成日**: 2026-01-17
**バージョン**: 1.0
**ステータス**: MVP（最小実装）

---

## 1. 概要

### 1.1 目的

Zoomを常時接続した災害対応会議において、参加者が発話した内容を**取りこぼしなく**収集し、**話者を確実に特定**した上で、クロノロジー（時系列記録）として保存・参照できるようにする。

### 1.2 背景

従来のVAD（音声活動検知）方式では以下の問題があった：

- 話し始め・話し終わりが切れる
- 話者分離の精度が不安定
- ネットワーク障害時にデータが消失

これらを解決するため、**Push-to-Talk方式**（スペースキー長押し録音）に変更する。

### 1.3 対象ユーザー

- DMAT（災害派遣医療チーム）
- 災害対応本部の各拠点担当者
- 固定メンバーで、各自PCにWebアプリアクセス可能

---

## 2. システム構成

### 2.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│  各本部PC（ブラウザ）                                            │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Webアプリ（録音クライアント）                           │   │
│  │  - 本部名でログイン                                      │   │
│  │  - Spaceキー検知 → 録音開始/停止                        │   │
│  │  - ローカル保存（IndexedDB）                             │   │
│  │  - サーバーへ送信（リトライ機能付き）                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Zoom（別ウィンドウ）                                    │   │
│  │  - 音声通話用                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│  バックエンドサーバー（既存Azure環境）                           │
│                                                                 │
│  - 音声受信API                                                  │
│  - Azure STT（文字起こし）                                      │
│  - Azure OpenAI（分類・要約）                                   │
│  - クロノロジー保存（Azure Blob Storage）                       │
│  - WebSocket（リアルタイム通知）                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  クロノロジー表示画面（既存）                                    │
│  - 時系列で発話一覧表示                                         │
│  - 話者（本部名）でフィルタリング                               │
│  - カテゴリ（指示/報告/依頼等）でフィルタリング                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 データフロー

```
1. ユーザーが本部名でログイン
2. 「監視開始」ボタンを押す
3. Spaceキー押下 → 録音開始
4. Spaceキー離す → 録音停止
5. ローカルに一時保存（IndexedDB）
6. サーバーへ送信
   - 成功 → ローカルデータ削除
   - 失敗 → リトライキューに追加
7. サーバーでAzure STT処理
8. 分類・要約処理
9. クロノロジーとして保存
10. WebSocketで各クライアントに通知
```

---

## 3. 機能要件

### 3.1 認証・ログイン

| 項目 | 内容 |
|------|------|
| ログイン方式 | 本部名（テキスト入力）+ セッションID |
| セッション管理 | ブラウザローカルストレージ |
| ログアウト | 手動ログアウトボタン |

**ログイン画面の入力項目**:
- セッションID（既存の訓練/会議を選択）
- 本部名（テキスト入力、例：「北海道調整本部」）

**注意**: 本部名はマスタ登録されていない名前でも入力可能とする（新規本部の即時参加を可能にするため）

### 3.2 録音機能（Push-to-Talk）

| 項目 | 内容 |
|------|------|
| 録音トリガー | Spaceキー押下（keydown） |
| 録音停止 | Spaceキー離す（keyup） |
| 最小録音時間 | 500ms未満は破棄 |
| 最大録音時間 | 60秒で強制停止・送信 |
| 音声形式 | WebM/Opus（ブラウザ標準） |
| サンプルレート | 16kHz mono |

**キーボードイベント仕様**:
```javascript
- keydown（Space） → 録音開始（repeatは無視）
- keyup（Space）   → 録音停止 → 送信処理開始
```

**プリロール（将来実装）**:
- 録音開始前300msのバッファを含める機能
- MVP では実装しない

### 3.3 ローカル保存（取りこぼし防止）

| 項目 | 内容 |
|------|------|
| 保存先 | IndexedDB |
| 保存タイミング | 録音停止直後（送信前） |
| 保存内容 | 音声Blob、メタデータ |
| 削除タイミング | サーバー送信成功後 |
| 保持期間 | 最大24時間（その後自動削除） |

**ローカルDBスキーマ**:
```
pending_segments:
  - local_id: string (UUID)
  - session_id: string
  - speaker_name: string
  - audio_blob: Blob
  - start_time: ISO8601
  - end_time: ISO8601
  - created_at: ISO8601
  - status: 'pending' | 'uploading' | 'uploaded' | 'failed'
  - retry_count: number
  - last_error: string | null
```

### 3.4 送信・リトライ機能

| 項目 | 内容 |
|------|------|
| 送信先 | POST /api/sessions/{session_id}/audio |
| リトライ回数 | 最大5回 |
| リトライ間隔 | 指数バックオフ（5秒、10秒、20秒、40秒、80秒） |
| オフライン検知 | navigator.onLine で判定 |
| オフライン時 | キューに蓄積、オンライン復帰で自動送信 |

**送信状態遷移**:
```
pending → uploading → uploaded（完了）
              ↓
           failed → pending（リトライ）
              ↓
           failed（リトライ上限）→ 手動対応必要
```

### 3.5 UI要件

**録音画面**:

```
┌─────────────────────────────────────────────────────────────┐
│  ChronologyAI - 録音モード                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  セッション：DMAT関東ブロック訓練                            │
│  ログイン中：【北海道調整本部】                    [ログアウト] │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │    状態表示エリア                                   │   │
│  │    - 待機中：「Spaceキーを押して録音」              │   │
│  │    - 録音中：「🔴 録音中... 00:05」                 │   │
│  │    - 送信中：「📤 送信中...」                       │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ───────────────────────────────────────────────────────── │
│  送信履歴（直近10件）：                                      │
│    ✓ 10:32:15 - 送信完了（12秒）                           │
│    ✓ 10:28:43 - 送信完了（8秒）                            │
│    ⟳ 10:25:01 - リトライ中（2/5）                          │
│    ✗ 10:20:33 - 失敗（手動再送信が必要）[再送信]            │
│                                                             │
│  ───────────────────────────────────────────────────────── │
│  未送信: 2件  [すべて再送信]                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**状態インジケーター**:
- 🟢 待機中（緑）
- 🔴 録音中（赤、点滅）
- 🟡 送信中（黄）
- ⚠️ エラーあり（オレンジ）

---

## 4. API仕様

### 4.1 既存APIの変更

**POST /api/sessions/{session_id}/audio** (変更)

現在の `participant_id` に加えて `speaker_name` パラメータを追加：

```
Request:
  Content-Type: multipart/form-data

  audio: File (WAV/WebM)
  speaker_name: string (例: "北海道調整本部")  ← 追加
  participant_id: string (optional、互換性のため残す)
  timestamp: ISO8601
  local_segment_id: string (クライアント側UUID) ← 追加
  start_time: ISO8601 ← 追加
  end_time: ISO8601 ← 追加

Response:
  {
    "ok": true,
    "segment_id": "uuid",
    "entry_id": "uuid",
    "received_at": "ISO8601"
  }
```

### 4.2 新規API

**POST /api/sessions/{session_id}/speakers** (新規)

話者（本部）の登録・参加：

```
Request:
  {
    "speaker_name": "北海道調整本部",
    "device_info": {
      "user_agent": "...",
      "platform": "..."
    }
  }

Response:
  {
    "speaker_id": "uuid",
    "speaker_name": "北海道調整本部",
    "session_id": "...",
    "joined_at": "ISO8601"
  }
```

**GET /api/sessions/{session_id}/speakers** (新規)

参加中の話者一覧：

```
Response:
  {
    "speakers": [
      {
        "speaker_id": "uuid",
        "speaker_name": "北海道調整本部",
        "joined_at": "ISO8601",
        "last_activity": "ISO8601",
        "is_online": true
      }
    ]
  }
```

---

## 5. 現行実装からの差分

### 5.1 フロントエンド変更

| ファイル | 変更内容 |
|----------|----------|
| `record/page.tsx` | VAD方式 → Push-to-Talk方式に変更 |
| 新規: `record-ptt/page.tsx` | Push-to-Talk専用ページ（既存と並行運用可） |
| 新規: `hooks/useLocalStorage.ts` | IndexedDB操作フック |
| 新規: `hooks/usePushToTalk.ts` | Spaceキー検知・録音制御フック |
| 新規: `components/SpeakerLogin.tsx` | 本部名ログインコンポーネント |
| 新規: `lib/offlineQueue.ts` | オフライン時キュー管理 |

### 5.2 バックエンド変更

| ファイル | 変更内容 |
|----------|----------|
| `api/zoom.py` | `speaker_name` パラメータ追加 |
| `services/zoom_bot.py` | `speaker_name` から話者特定ロジック追加 |
| `models/schemas.py` | `Speaker` スキーマ追加 |
| 新規: `api/speakers.py` | 話者管理API |

### 5.3 削除・無効化する機能

| 機能 | 対応 |
|------|------|
| VAD自動検知 | Push-to-Talkページでは無効化（既存ページは残す） |
| 話者選択ドロップダウン | ログイン時の入力に置き換え |
| プリロール/ポストロール | MVP では実装しない |

---

## 6. 非機能要件

### 6.1 パフォーマンス

| 項目 | 要件 |
|------|------|
| 録音開始遅延 | 100ms以内 |
| 送信完了時間 | 30秒以内（60秒音声の場合） |
| 同時接続数 | 20本部以上 |

### 6.2 信頼性

| 項目 | 要件 |
|------|------|
| 音声取りこぼし | 0%（ローカル保存で保証） |
| 送信成功率 | 99%以上（リトライ込み） |
| データ保持 | ローカル24時間、サーバー永続 |

### 6.3 セキュリティ

| 項目 | 要件 |
|------|------|
| 通信 | HTTPS必須 |
| 認証 | セッションベース（将来的にトークン認証） |
| 音声データ | Azure内で処理、外部送信なし |

---

## 7. 運用フロー

### 7.1 訓練開始前

1. 管理者がセッションを作成
2. 各本部にセッションIDを共有
3. 各本部担当者がWebアプリにアクセス
4. 本部名を入力してログイン
5. 「監視開始」を押して待機

### 7.2 訓練中

1. Zoomで会議に参加（別ウィンドウ）
2. 発話時：
   - Zoomでアンミュート
   - Spaceキーを押しながら話す
   - 話し終わったらSpaceキーを離す
   - Zoomでミュート
3. Webアプリの送信履歴で送信状況を確認

### 7.3 障害時

1. ネットワーク切断時：
   - 音声はローカルに保存される
   - 復旧後、自動で再送信
2. 送信失敗時：
   - 自動リトライ（5回まで）
   - 失敗継続時は手動「再送信」ボタン

---

## 8. 実装スケジュール（案）

| フェーズ | 内容 | 期間 |
|----------|------|------|
| Phase 1 | Push-to-Talk基本機能 | 1-2日 |
| Phase 2 | ローカル保存・リトライ | 1日 |
| Phase 3 | 話者ログイン機能 | 1日 |
| Phase 4 | UI改善・テスト | 1日 |

**合計**: 4-5日

---

## 9. 将来の拡張（MVP後）

- [ ] プリロール機能（話し始め前300msを含める）
- [ ] Zoomミュート状態連携（SDK連携）
- [ ] 音声波形表示
- [ ] ショートカットキーのカスタマイズ
- [ ] モバイル対応（タップで録音）
- [ ] 複数デバイスからの同一話者ログイン制御

---

## 10. 用語集

| 用語 | 説明 |
|------|------|
| Push-to-Talk | キーを押している間だけ録音する方式 |
| VAD | Voice Activity Detection（音声活動検知） |
| IndexedDB | ブラウザ内蔵のローカルデータベース |
| セグメント | 1回の発話（録音開始〜停止）の単位 |
| クロノロジー | 時系列で整理された発話記録 |
| 本部 | 災害対応の各拠点（話者単位） |

---

## 改訂履歴

| 日付 | バージョン | 内容 |
|------|------------|------|
| 2026-01-17 | 1.0 | 初版作成 |
