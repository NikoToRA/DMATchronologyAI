# 2026-01-18 次回TODO：会話の塊化と関連課題

## 背景
- 現状は音声セグメント単位でクロノロジーが生成されるため、発話が細切れになりやすい。
- A本部/B本部など複数話者が同時〜短時間に往復すると、ログ一覧のように短冊が増え、状況把握が難しくなる。

## 主要課題（次回スコープ）

### 1) 会話の「塊」化（Conversation Chunking）
#### 目的
- “会話の往復” を 1 つの短冊（イベント）として表示し、可読性と意思決定速度を上げる。

#### 方向性（案）
- **バックエンドで集約してからクロノロジーを作る（推奨）**
  - segment（発話）→ conversation_chunk（会話塊）→ chronology_entry（短冊）
  - これにより、UIだけでなくAPI出力も一貫して“塊”になる。

#### 集約ルール（初期案）
- **時間窓**：
  - 連続発話の間隔が \(T\) 秒以内なら同一塊に結合（例：T=10〜20秒）
- **同時発話**：
  - 近接時刻（同一時間窓）に複数 participant_id がある場合、同一塊に含める（話者リストとして保持）
- **例外**：
  - カテゴリが「指示/要請」等の場合は分割維持（短冊が重要なため）

#### 仕様（データ構造の案）
- conversation_chunk:
  - chunk_id
  - session_id
  - start_at / end_at
  - participants: [{ participant_id, hq_id?, hq_name?, text_raw, confidence, audio_path? }]
  - merged_text_raw（連結した全文）
  - merged_summary / category（分類結果）
  - source_segment_ids（トレース用）

#### UI方針（案）
- 短冊（塊）を基本表示
- 展開で “この塊に含まれる発話一覧（話者別）” を表示
- フィルタ：HQ / カテゴリ / 「塊のみ」「生ログ（segment）も表示」トグル

#### 受け入れ条件（例）
- A本部とB本部の往復が **1〜数枚**の短冊にまとまり、時系列の流れが読みやすい
- “重要な指示/要請” は過度にまとめられず、追える

---

### 2) ユーザー辞書の永続化・管理画面反映・STT反映
#### 現状
- ローカルでは `config/user_dictionary.json` がマウントされるが、Webデプロイでは消失しやすい。

#### 次回TODO
- **管理画面（Settings）で辞書CRUDを運用可能にする**
  - 取得/追加/編集/無効化/削除
  - 変更が即反映されること（更新→数秒以内に反映）
- **STTへの反映を強化**
  - 後処理置換（確実）＋ Speech SDK PhraseList（精度向上）を併用
  - 用語の優先度や同音異義の扱い（長い順に置換、正規表現可否など）を決める

---

## 併せて改善したい課題（優先度：中）

### 3) 音声キューの自動再送（オートで流す）
- 目的：現場では手動ボタンに頼らず、オンライン復帰時に自動で詰まりを解消
- TODO案：
  - ページ表示時/オンライン復帰時に `processQueue(sessionId, true)` を自動トリガ（ただし無限リトライ防止が必須）
  - “破損確定(convert失敗)” や “skipped(silence/stt)” は **未送信扱いから除外**し、キューを詰まらせない
  - 送信結果をUIに分かりやすく表示（成功/スキップ/失敗）

### 4) STT NoMatch（stage=stt, text_len=0）対策の継続
- 目的：短い発話や小音量でも文字化できる率を上げる
- TODO案：
  - 音量正規化/ノイズ抑制パラメータの再評価
  - Azure Speech の NoMatch理由（timeout等）をログ/レスポンスで可視化
  - セグメント長（録音/分割）を調整（短すぎる/長すぎる問題）

---

## 次回の実装順（提案）
1. 会話の塊化：ルール確定 → バックエンド集約 → UI表示/展開
2. 辞書：管理画面CRUD → STT反映（後処理＋PhraseList）
3. オート再送：スキップ/破損の扱いを含めて安定化
4. STT NoMatch：観測点追加 → チューニング

