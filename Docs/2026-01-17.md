# 2026-01-17 作業メモ（音声→STT→クロノロジー復旧 / 次の課題）

## 今日できたこと（成果）
- **音声入力→送信→STT→クロノロジー反映**が動作するところまで復旧
  - `stage: stt` で `stt_text_len: 0` になる問題を解消（Azure Speech SDKへWAVヘッダ込みをPushしていたのが原因）
  - `ok: true / stage: done / entry_id発行` を確認
- **クロノロジー表示の方針**を反映（生の文字起こしを隠す）
  - 表題（1行）＝ `summary`
  - 本文（AI要約）＝ `ai_note`（新設）
  - 文字起こし（`text_raw`）は **デフォルト非表示**（必要時のみ開く）
- **HQ宣言の取り込み強化**
  - 「〜本部です」「〜本部から」等の宣言からHQを拾う
  - HQマスターに無い宣言は **自動でHQを追加**し、参加者に紐付ける（未確定対策）
  - 宣言名の正規化（`ええと/えっと/あの` 等フィラー、括弧、句読点の除去）

## 重要な発見（原因切り分け）
- フロント側のVAD/録音は見た目上動いていても、**MediaRecorderがstart/stopできていない**と送信できない
  - 送信は「録音停止」で起きるため、ノイズ環境では止まらず送信されない問題が出やすい
  - デバッグ表示（`rec_state/mime/chunks/lastChunkSize` など）で切り分けできるようにした
- バックエンド側は音声保存できていても、**Azure Speechに渡す入力形式が不正**だと `stt_text_len=0` で止まる
  - 対策：WAVコンテナを剥がして **PCMフレームを AudioStreamFormat 指定で Push**

## 現状の挙動（スクショ状況）
- クロノロジーに以下が出る
  - 発信者が未確定のレコードが残ることがある（宣言表現の揺れ・フィラー混入が主因）
  - 「DMAT」が「ディーマット」等に揺れる（辞書/用語バイアスが必要）

## これからの課題（優先度順）

### 1) **最低限の辞書登録（用語バイアス）**
- **目的**: DMAT、病院名、隊名、地名、略語が安定して認識される
- **現状**: PhraseListGrammarで少数の用語バイアスを入れたが、まだ揺れが残る
- **次の打ち手**
  - **Azure Speech Custom Speech / Phrase List** の運用方針を決める
  - 事故/災害ごとの固有名詞（病院/拠点/道路/隊）を「災害ボックス」単位で管理する
  - UIから「辞書（用語）」を追加できる導線を検討

### 2) **発信者（HQ）の自動確定をより堅牢に**
- **目的**: 「未確定」を極力出さない（現場で手修正を減らす）
- **現状**:
  - 宣言が「ええと北海道調整本部から…」のように汚れると未確定になりうる
  - 参加者（participant）→HQ紐付けはあるが、宣言を根拠にした補正が必要
- **次の打ち手**
  - 宣言パターンを増やす（例：`^(.+?)です` のような広いものは誤爆注意で段階導入）
  - 「宣言で検出したHQ名」がHQマスターに無い場合の自動追加は維持しつつ、
    - 近似一致（表記揺れ：都道府県/道/県名、スペース、漢字/かな）を追加
  - UIで「未確定」をタップして候補から即確定できるUX強化

### 3) **LLMプロンプト（クロノロジー専門家）を固める**
- **目的**: 文字起こしを“災害医療クロノロジーとして”整形・抽出し、現場が読める情報にする
- **現状**:
  - 分類/表題/要約（`summary`/`ai_note`）のフォーマットをJSONで返すように変更
- **次の打ち手**
  - **基本プロンプト**（災害医療クロノロジーのエキスパート）を固定
  - 出力のルールを追加
    - 数量/時間/到着見込み/宛先/依頼先/手配内容を必ず含める
    - “誰が誰に何を”を明確化
  - `has_task` の判定を強化（依頼/指示だけでなく、明確な作業が含まれる文も拾う）

### 4) **UI: 生の文字起こしは基本非表示を継続**
- **目的**: クロノロジーは「読める1行＋要約」に集中させ、ノイズの多い文字起こしを隠す
- **現状**:
  - `summary`（表題）＋ `ai_note`（本文）を表示
  - `text_raw` は `<details>` 内に格納して必要時だけ表示
- **次の打ち手**
  - 編集時のみ `text_raw` を見せる/修正できる設計に寄せる
  - 監査/検証用途で「全文表示」トグルをページ単位で持たせる

### 5) 運用・デバッグ性
- **音声入力画面**で `stage/ok/stt_text_len/stt_confidence/rms_db/wav情報` が見えるのは非常に有効
- 次は
  - 「直近N件の送信結果ログ」を見られる（履歴）と現場で強い
  - 失敗時のガイダンス（例：`stt_configured=false` のとき設定誘導）を強化

## 次回の再開手順（最短）
1. バックエンド起動（`uvicorn app.main:app --port 8000`）
2. フロント起動（Next.js）
3. `音声入力` → 強制送信で `ok:true stage:done entry_id` を確認
4. クロノロジーで
   - `summary`（表題）
   - `ai_note`（本文）
   - 文字起こしは非表示（必要時のみ展開）
   を確認

